import{j as t}from"./jsx-runtime.D_zvdyIk.js";import{r}from"./index.DiEladB3.js";function Z({node:s,onClose:i}){return t.jsxs("div",{className:"border-skin-accent/30 bg-skin-card rounded-lg border p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("h3",{className:"text-skin-base font-semibold",style:s.color?{color:s.color}:void 0,children:s.label}),s.annotation&&t.jsx("span",{className:"rounded px-1.5 py-0.5 text-xs font-medium text-white",style:{backgroundColor:s.color||"#888"},children:s.annotation})]}),t.jsx("button",{onClick:i,className:"text-skin-base/60 hover:bg-skin-card-muted hover:text-skin-accent flex h-6 w-6 flex-shrink-0 items-center justify-center rounded transition-colors","aria-label":"Close notes",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),t.jsx("p",{className:"text-skin-base/80 mt-2 text-sm leading-relaxed",children:s.notes}),s.refs&&s.refs.length>0&&t.jsxs("div",{className:"border-skin-line/30 mt-3 border-t pt-2",children:[t.jsx("p",{className:"text-skin-base/50 text-xs font-medium tracking-wide uppercase",children:"Related"}),t.jsx("div",{className:"mt-1 flex flex-wrap gap-1.5",children:s.refs.map(c=>t.jsxs("span",{className:"inline-flex items-center gap-1 rounded bg-yellow-500/10 px-2 py-0.5 text-xs text-yellow-600 dark:text-yellow-400",children:[c.label&&t.jsx("span",{className:"opacity-70",children:c.label}),t.jsx("span",{className:"font-medium",children:c.targetId})]},c.targetId))})]})]})}const fe={"#326ce5":{light:"#2563EB",dark:"#60A5FA"},"#0f1689":{light:"#3B5FD4",dark:"#7B9EFF"},"#7b42bc":{light:"#7B42BC",dark:"#A78BFA"},"#ee0000":{light:"#DC2626",dark:"#F87171"},"#e00":{light:"#DC2626",dark:"#F87171"},"#ff0000":{light:"#DC2626",dark:"#F87171"},"#0ea5e9":{light:"#0284C7",dark:"#38BDF8"},"#f59e0b":{light:"#D97706",dark:"#FCD34D"},"#10b981":{light:"#059669",dark:"#34D399"},"#ec4899":{light:"#DB2777",dark:"#F472B6"}};function xe(s){const i=s.trim().toLowerCase();return/^#[0-9a-f]{3}$/.test(i)?"#"+i[1]+i[1]+i[2]+i[2]+i[3]+i[3]:i}function J(s,i){const c=xe(s),a=fe[c];return a?i?a.dark:a.light:s}const K=["#326CE5","#0F1689","#7B42BC","#EE0000","#0EA5E9","#F59E0B","#10B981","#EC4899"];function pe(s){const i=[],c=[],a=new Map;function f(l){if(!l.children||l.children.length===0)return a.set(l.id,1),1;let g=0;for(const p of l.children)g+=f(p);return a.set(l.id,g),g}f(s);const v=[0,220,400,560,700,830],d=l=>l<v.length?v[l]:v[v.length-1]+(l-v.length+1)*140;i.push({id:s.id,label:s.label,x:0,y:0,color:"#10B981",node:s,depth:0,parentId:null});function b(l,g,p,E,P,$){if(!l.children||l.children.length===0)return;const B=a.get(l.id)||1,S=d(p);let A=E;l.children.forEach((x,H)=>{const R=a.get(x.id)||1,M=(P-E)*R/B,L=A+M/2,N=x.color||(p===1?K[H%K.length]:$),O=Math.cos(L)*S,I=Math.sin(L)*S;if(i.push({id:x.id,label:x.label,x:O,y:I,color:N,node:x,depth:p,parentId:g}),c.push({from:g,to:x.id,isRef:!1}),x.refs)for(const F of x.refs)c.push({from:x.id,to:F.targetId,isRef:!0,label:F.label});b(x,x.id,p+1,A,A+M,N),A+=M})}const y=-Math.PI,j=Math.PI;return b(s,s.id,1,y,j,"#10B981"),{nodes:i,edges:c}}function ke(s,i,c,a){const f=(s+c)/2,v=(i+a)/2,d=c-s,b=a-i,y=Math.sqrt(d*d+b*b)||1,j=y*.15,l=-b/y,g=d/y,p=f+l*j,E=v+g*j;return`M ${s} ${i} Q ${p} ${E} ${c} ${a}`}function ge(s,i,c,a){const f=(s+c)/2,v=(i+a)/2,d=c-s,b=a-i,y=Math.sqrt(d*d+b*b)||1,j=-b/y,l=d/y,g=y*.25,p=f+j*g,E=v+l*g;return`M ${s} ${i} Q ${p} ${E} ${c} ${a}`}function me(s,i){const a=(i===0?16:i===1?13:11)*.62;return Math.max(60,s.length*a+28)}const be=32,ye=40,ve=5;function Ce({mindmap:s}){const i=r.useRef(null),[c,a]=r.useState(null),[f,v]=r.useState(null),[d,b]=r.useState(!1),[y,j]=r.useState(()=>{const e=new Set;return e.add(s.root.id),s.root.children?.forEach(n=>{e.add(n.id),n.children?.forEach(o=>e.add(o.id))}),e}),[l,g]=r.useState({x:0,y:0}),[p,E]=r.useState(.65),P=r.useRef(!1),$=r.useRef({x:0,y:0}),B=r.useRef({x:0,y:0}),[S,A]=r.useState(!1);r.useEffect(()=>{const e=()=>A(document.documentElement.dataset.theme==="dark"||document.documentElement.classList.contains("dark"));e();const n=new MutationObserver(e);return n.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme","class"]}),()=>n.disconnect()},[]);const[x,H]=r.useState(new Map),R=r.useRef(null),M=r.useRef({px:0,py:0}),L=r.useRef({dx:0,dy:0}),N=r.useRef(!1),O=r.useMemo(()=>{function e(n){return!y.has(n.id)||!n.children?{...n,children:void 0}:{...n,children:n.children.map(e)}}return e(s.root)},[s.root,y]),{nodes:I,edges:F}=r.useMemo(()=>pe(O),[O]),W=r.useMemo(()=>{const e=new Map;for(const n of I)e.set(n.id,n);return e},[I]),z=r.useCallback(e=>{const n=W.get(e);if(!n)return null;const o=x.get(e);return{x:n.x+(o?.dx??0),y:n.y+(o?.dy??0)}},[W,x]),ee=r.useCallback(e=>{function n(u){if(u.id===e)return u;if(u.children)for(const h of u.children){const m=n(h);if(m)return m}return null}const o=n(s.root);!o||!o.children||o.children.length===0||j(u=>{const h=new Set(u);if(h.has(e)){let m=function(w){if(w.children)for(const C of w.children)h.delete(C.id),m(C)};h.delete(e),m(o)}else h.add(e);return h})},[s.root]),te=r.useCallback(()=>{const e=new Set;function n(o){e.add(o.id),o.children?.forEach(n)}n(s.root),j(e)},[s]),ne=r.useCallback(()=>{j(new Set([s.root.id]))},[s]),se=r.useCallback(()=>{H(new Map)},[]),Y=r.useCallback(e=>{if(i.current){const n=i.current.getBoundingClientRect();g({x:n.width/2,y:n.height/2}),E(e)}},[]),oe=r.useCallback(()=>{Y(.65)},[Y]),_=r.useCallback(()=>{b(e=>!e)},[]),q=r.useMemo(()=>{const e=new Map;function n(o){e.set(o.id,o.children?.length??0),o.children?.forEach(n)}return n(s.root),e},[s.root]),re=r.useCallback(e=>{R.current===null&&e.button===0&&(P.current=!0,$.current={x:e.clientX,y:e.clientY},B.current={...l},e.target.setPointerCapture?.(e.pointerId))},[l]),ie=r.useCallback(e=>{if(R.current!==null){const u=(e.clientX-M.current.px)/p+L.current.dx,h=(e.clientY-M.current.py)/p+L.current.dy;if(!N.current){const m=e.clientX-M.current.px,w=e.clientY-M.current.py;Math.sqrt(m*m+w*w)>ve&&(N.current=!0)}if(N.current){const m=R.current;H(w=>{const C=new Map(w);return C.set(m,{dx:u,dy:h}),C})}return}if(!P.current)return;const n=e.clientX-$.current.x,o=e.clientY-$.current.y;g({x:B.current.x+n,y:B.current.y+o})},[p]),ce=r.useCallback(()=>{P.current=!1,R.current=null},[]);r.useEffect(()=>{const e=i.current;if(!e)return;const n=o=>{o.preventDefault();const u=o.deltaY>0?.92:1.08;E(h=>Math.max(.15,Math.min(3,h*u)))};return e.addEventListener("wheel",n,{passive:!1}),()=>e.removeEventListener("wheel",n)},[d]),r.useEffect(()=>{Y(.65)},[]),r.useEffect(()=>{const e=requestAnimationFrame(()=>Y(.65));return()=>cancelAnimationFrame(e)},[d]),r.useEffect(()=>{if(!d)return;const e=n=>{n.key==="Escape"&&b(!1)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[d]),r.useEffect(()=>(document.body.style.overflow=d?"hidden":"",()=>{document.body.style.overflow=""}),[d]);const le=x.size>0,T=t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx("button",{onClick:te,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",children:"Expand All"}),t.jsx("button",{onClick:ne,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",children:"Collapse All"}),t.jsx("button",{onClick:oe,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",children:"Reset View"}),le&&t.jsx("button",{onClick:se,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",children:"Reset Layout"}),t.jsxs("button",{onClick:_,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",title:d?"Exit expanded view (Esc)":"Expand to full viewport",children:[d?t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{display:"inline",width:12,height:12,verticalAlign:"middle"},children:[t.jsx("path",{d:"M8 3v3a2 2 0 0 1-2 2H3"}),t.jsx("path",{d:"M21 8h-3a2 2 0 0 1-2-2V3"}),t.jsx("path",{d:"M3 16h3a2 2 0 0 1 2 2v3"}),t.jsx("path",{d:"M16 21v-3a2 2 0 0 1 2-2h3"})]}):t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{display:"inline",width:12,height:12,verticalAlign:"middle"},children:[t.jsx("path",{d:"M3 7V5a2 2 0 0 1 2-2h2"}),t.jsx("path",{d:"M17 3h2a2 2 0 0 1 2 2v2"}),t.jsx("path",{d:"M21 17v2a2 2 0 0 1-2 2h-2"}),t.jsx("path",{d:"M7 21H5a2 2 0 0 1-2-2v-2"})]}),t.jsx("span",{className:"ml-1",children:d?"Exit":"Expand"})]}),t.jsxs("span",{className:"text-skin-base/50 ml-auto text-xs",children:["Scroll to zoom · Drag canvas to pan · Drag nodes to reposition · Click to expand · Right-click for notes",d&&" · Esc to exit"]})]}),G=t.jsx("div",{ref:i,className:"border-skin-line bg-skin-fill relative overflow-hidden rounded-lg border",style:{height:d?"calc(100vh - 120px)":"600px",touchAction:"none"},onPointerDown:re,onPointerMove:ie,onPointerUp:ce,children:t.jsx("svg",{className:"mindmap-canvas",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",display:"block"},children:t.jsxs("g",{transform:`translate(${l.x}, ${l.y}) scale(${p})`,children:[t.jsx("defs",{children:t.jsx("marker",{id:"ref-arrow",markerWidth:"8",markerHeight:"8",refX:"7",refY:"4",orient:"auto",children:t.jsx("path",{d:"M 0 0 L 8 4 L 0 8 Z",fill:"#888",opacity:"0.5"})})}),F.filter(e=>!e.isRef).map(e=>{const n=z(e.from),o=z(e.to),u=W.get(e.to);if(!n||!o||!u)return null;const h=f===e.from||f===e.to,m=J(u.color,S);return t.jsx("path",{d:ke(n.x,n.y,o.x,o.y),fill:"none",stroke:m,strokeWidth:h?2.5:1.5,opacity:f?h?.9:.15:.5,style:{transition:"opacity 0.2s, stroke-width 0.2s"}},`${e.from}-${e.to}`)}),F.filter(e=>e.isRef).map(e=>{const n=z(e.from),o=z(e.to);if(!n||!o)return null;const u=f===e.from||f===e.to,h=S?"#FCD34D":"#D97706";return t.jsxs("g",{children:[t.jsx("path",{d:ge(n.x,n.y,o.x,o.y),fill:"none",stroke:h,strokeWidth:u?2:1.2,strokeDasharray:"6 4",opacity:f?u?.9:.12:.4,markerEnd:"url(#ref-arrow)",style:{transition:"opacity 0.2s"}}),e.label&&t.jsx("text",{x:(n.x+o.x)/2,y:(n.y+o.y)/2-8,textAnchor:"middle",fontSize:"9",fill:h,opacity:f?u?.9:.1:.55,style:{pointerEvents:"none"},children:e.label})]},`ref-${e.from}-${e.to}`)}),I.map(e=>{const n=e.depth===0,o=me(e.label,e.depth),u=n?ye:be,h=(q.get(e.id)??0)>0,m=y.has(e.id),w=f===e.id,C=c?.id===e.id,U=!!e.node.notes,ae=!!e.node.annotation,de=q.get(e.id)??0,X=h&&!m?de:0,D=J(e.color,S),Q=x.get(e.id),ue=e.x+(Q?.dx??0),he=e.y+(Q?.dy??0);return t.jsxs("g",{transform:`translate(${ue}, ${he})`,onMouseEnter:()=>v(e.id),onMouseLeave:()=>v(null),onPointerDown:k=>{if(k.stopPropagation(),k.button!==0)return;R.current=e.id,M.current={px:k.clientX,py:k.clientY};const V=x.get(e.id);L.current={dx:V?.dx??0,dy:V?.dy??0},N.current=!1,k.target.setPointerCapture?.(k.pointerId)},onPointerUp:k=>{k.stopPropagation();const V=N.current;R.current=null,N.current=!1,V||k.button===0&&h&&ee(e.id)},onContextMenu:k=>{k.preventDefault(),k.stopPropagation(),U&&a(c?.id===e.id?null:e.node)},style:{cursor:h?"grab":"default"},children:[t.jsx("rect",{x:-o/2,y:-u/2,width:o,height:u,rx:n?12:8,fill:n?D:C?D+"30":w?D+"20":D+"12",stroke:D,strokeWidth:n?2.5:C?2:w?1.5:1,opacity:f&&!w&&f!==e.parentId?(()=>{const k=W.get(f);return k&&(e.parentId===f||k.parentId===e.id)?.9:.4})():1,style:{transition:"opacity 0.2s, fill 0.15s, stroke-width 0.15s"}}),t.jsx("text",{textAnchor:"middle",dominantBaseline:"central",fontSize:n?15:e.depth===1?12:10.5,fontWeight:n||e.depth===1?"bold":"500",fill:n?"#ffffff":D,style:{pointerEvents:"none",userSelect:"none"},children:e.label}),ae&&t.jsxs("g",{transform:`translate(${o/2-4}, ${-u/2-6})`,children:[t.jsx("rect",{x:-2,y:-7,width:(e.node.annotation?.length??0)*5.5+10,height:14,rx:4,fill:D,opacity:.85}),t.jsx("text",{x:3,fontSize:"8",fontWeight:"600",fill:"white",style:{pointerEvents:"none",userSelect:"none"},children:e.node.annotation})]}),X>0&&t.jsxs("g",{transform:`translate(${o/2+4}, 0)`,children:[t.jsx("circle",{r:9,fill:D,opacity:.7}),t.jsxs("text",{textAnchor:"middle",dominantBaseline:"central",fontSize:"8",fontWeight:"bold",fill:"white",style:{pointerEvents:"none",userSelect:"none"},children:["+",X]})]}),U&&t.jsx("circle",{cx:o/2+(X>0?20:4),cy:-u/2+4,r:3.5,fill:C?D:S?"#FCD34D":"#D97706",opacity:w||C?1:.5,style:{transition:"opacity 0.15s"}})]},e.id)})]})})});return d?t.jsxs("div",{style:{position:"fixed",inset:0,zIndex:9999,display:"flex",flexDirection:"column",gap:"0.5rem",padding:"0.75rem",backgroundColor:"rgb(var(--color-fill))",overflow:"hidden"},children:[t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("h2",{className:"text-skin-base text-base leading-tight font-bold",children:s.title}),t.jsx("button",{onClick:_,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2 py-1 text-xs transition-colors",title:"Exit (Esc)",children:"✕ Exit"})]}),T,G,c&&c.notes&&t.jsx("div",{style:{flexShrink:0,maxHeight:"30vh",overflowY:"auto"},children:t.jsx(Z,{node:c,onClose:()=>a(null)})})]}):t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-skin-base text-xl font-bold",children:s.title}),t.jsx("p",{className:"text-skin-base/70 mt-1 text-sm",children:s.description})]}),T,G,c&&c.notes&&t.jsx(Z,{node:c,onClose:()=>a(null)})]})}export{Ce as MindMapViewer};
