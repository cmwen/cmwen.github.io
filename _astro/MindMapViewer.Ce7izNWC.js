import{j as t}from"./jsx-runtime.D_zvdyIk.js";import{r}from"./index.DiEladB3.js";function Y({node:s,onClose:a}){return t.jsxs("div",{className:"border-skin-accent/30 bg-skin-card rounded-lg border p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("h3",{className:"text-skin-base font-semibold",style:s.color?{color:s.color}:void 0,children:s.label}),s.annotation&&t.jsx("span",{className:"rounded px-1.5 py-0.5 text-xs font-medium text-white",style:{backgroundColor:s.color||"#888"},children:s.annotation})]}),t.jsx("button",{onClick:a,className:"text-skin-base/60 hover:bg-skin-card-muted hover:text-skin-accent flex h-6 w-6 flex-shrink-0 items-center justify-center rounded transition-colors","aria-label":"Close notes",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),t.jsx("p",{className:"text-skin-base/80 mt-2 text-sm leading-relaxed",children:s.notes}),s.refs&&s.refs.length>0&&t.jsxs("div",{className:"border-skin-line/30 mt-3 border-t pt-2",children:[t.jsx("p",{className:"text-skin-base/50 text-xs font-medium tracking-wide uppercase",children:"Related"}),t.jsx("div",{className:"mt-1 flex flex-wrap gap-1.5",children:s.refs.map(i=>t.jsxs("span",{className:"inline-flex items-center gap-1 rounded bg-yellow-500/10 px-2 py-0.5 text-xs text-yellow-600 dark:text-yellow-400",children:[i.label&&t.jsx("span",{className:"opacity-70",children:i.label}),t.jsx("span",{className:"font-medium",children:i.targetId})]},i.targetId))})]})]})}const q=["#326CE5","#0F1689","#7B42BC","#E00","#0EA5E9","#F59E0B","#10B981","#EC4899"];function Z(s){const a=[],i=[],x=new Map;function h(l){if(!l.children||l.children.length===0)return x.set(l.id,1),1;let f=0;for(const b of l.children)f+=h(b);return x.set(l.id,f),f}h(s);const g=[0,220,400,560,700,830],c=l=>l<g.length?g[l]:g[g.length-1]+(l-g.length+1)*140;a.push({id:s.id,label:s.label,x:0,y:0,color:"#10B981",node:s,depth:0,parentId:null});function p(l,f,b,y,$,R){if(!l.children||l.children.length===0)return;const A=x.get(l.id)||1,I=c(b);let j=y;l.children.forEach((u,w)=>{const W=x.get(u.id)||1,L=($-y)*W/A,H=j+L/2,E=u.color||(b===1?q[w%q.length]:R),F=Math.cos(H)*I,P=Math.sin(H)*I;if(a.push({id:u.id,label:u.label,x:F,y:P,color:E,node:u,depth:b,parentId:f}),i.push({from:f,to:u.id,isRef:!1}),u.refs)for(const B of u.refs)i.push({from:u.id,to:B.targetId,isRef:!0,label:B.label});p(u,u.id,b+1,j,j+L,E),j+=L})}const m=-Math.PI,v=Math.PI;return p(s,s.id,1,m,v,"#10B981"),{nodes:a,edges:i}}function U(s,a,i,x){const h=(s+i)/2,g=(a+x)/2,c=i-s,p=x-a,m=Math.sqrt(c*c+p*p)||1,v=m*.15,l=-p/m,f=c/m,b=h+l*v,y=g+f*v;return`M ${s} ${a} Q ${b} ${y} ${i} ${x}`}function J(s,a,i,x){const h=(s+i)/2,g=(a+x)/2,c=i-s,p=x-a,m=Math.sqrt(c*c+p*p)||1,v=-p/m,l=c/m,f=m*.25,b=h+v*f,y=g+l*f;return`M ${s} ${a} Q ${b} ${y} ${i} ${x}`}function K(s,a){const x=(a===0?16:a===1?13:11)*.62;return Math.max(60,s.length*x+28)}const ee=32,te=40;function oe({mindmap:s}){const a=r.useRef(null),[i,x]=r.useState(null),[h,g]=r.useState(null),[c,p]=r.useState(!1),[m,v]=r.useState(()=>{const e=new Set;return e.add(s.root.id),s.root.children?.forEach(n=>{e.add(n.id),n.children?.forEach(o=>e.add(o.id))}),e}),[l,f]=r.useState({x:0,y:0}),[b,y]=r.useState(.65),$=r.useRef(!1),R=r.useRef({x:0,y:0}),A=r.useRef({x:0,y:0}),I=r.useMemo(()=>{function e(n){return!m.has(n.id)||!n.children?{...n,children:void 0}:{...n,children:n.children.map(e)}}return e(s.root)},[s.root,m]),{nodes:j,edges:u}=r.useMemo(()=>Z(I),[I]),w=r.useMemo(()=>{const e=new Map;for(const n of j)e.set(n.id,n);return e},[j]),W=r.useCallback(e=>{function n(d){if(d.id===e)return d;if(d.children)for(const k of d.children){const C=n(k);if(C)return C}return null}const o=n(s.root);!o||!o.children||o.children.length===0||v(d=>{const k=new Set(d);if(k.has(e)){let C=function(M){if(M.children)for(const N of M.children)k.delete(N.id),C(N)};k.delete(e),C(o)}else k.add(e);return k})},[s.root]),L=r.useCallback(()=>{const e=new Set;function n(o){e.add(o.id),o.children?.forEach(n)}n(s.root),v(e)},[s]),H=r.useCallback(()=>{v(new Set([s.root.id]))},[s]),E=r.useCallback(e=>{if(a.current){const n=a.current.getBoundingClientRect();f({x:n.width/2,y:n.height/2}),y(e)}},[]),F=r.useCallback(()=>{E(.65)},[E]),P=r.useCallback(()=>{p(e=>!e)},[]),B=r.useMemo(()=>{const e=new Map;function n(o){e.set(o.id,o.children?.length??0),o.children?.forEach(n)}return n(s.root),e},[s.root]),T=r.useCallback(e=>{e.button===0&&($.current=!0,R.current={x:e.clientX,y:e.clientY},A.current={...l},e.target.setPointerCapture?.(e.pointerId))},[l]),X=r.useCallback(e=>{if(!$.current)return;const n=e.clientX-R.current.x,o=e.clientY-R.current.y;f({x:A.current.x+n,y:A.current.y+o})},[]),_=r.useCallback(()=>{$.current=!1},[]);r.useEffect(()=>{const e=a.current;if(!e)return;const n=o=>{o.preventDefault();const d=o.deltaY>0?.92:1.08;y(k=>Math.max(.15,Math.min(3,k*d)))};return e.addEventListener("wheel",n,{passive:!1}),()=>e.removeEventListener("wheel",n)},[c]),r.useEffect(()=>{E(.65)},[]),r.useEffect(()=>{const e=requestAnimationFrame(()=>E(.65));return()=>cancelAnimationFrame(e)},[c]),r.useEffect(()=>{if(!c)return;const e=n=>{n.key==="Escape"&&p(!1)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[c]),r.useEffect(()=>(document.body.style.overflow=c?"hidden":"",()=>{document.body.style.overflow=""}),[c]);const D=t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx("button",{onClick:L,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",children:"Expand All"}),t.jsx("button",{onClick:H,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",children:"Collapse All"}),t.jsx("button",{onClick:F,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",children:"Reset View"}),t.jsxs("button",{onClick:P,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",title:c?"Exit expanded view (Esc)":"Expand to full viewport",children:[c?t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{display:"inline",width:12,height:12,verticalAlign:"middle"},children:[t.jsx("path",{d:"M8 3v3a2 2 0 0 1-2 2H3"}),t.jsx("path",{d:"M21 8h-3a2 2 0 0 1-2-2V3"}),t.jsx("path",{d:"M3 16h3a2 2 0 0 1 2 2v3"}),t.jsx("path",{d:"M16 21v-3a2 2 0 0 1 2-2h3"})]}):t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{display:"inline",width:12,height:12,verticalAlign:"middle"},children:[t.jsx("path",{d:"M3 7V5a2 2 0 0 1 2-2h2"}),t.jsx("path",{d:"M17 3h2a2 2 0 0 1 2 2v2"}),t.jsx("path",{d:"M21 17v2a2 2 0 0 1-2 2h-2"}),t.jsx("path",{d:"M7 21H5a2 2 0 0 1-2-2v-2"})]}),t.jsx("span",{className:"ml-1",children:c?"Exit":"Expand"})]}),t.jsxs("span",{className:"text-skin-base/50 ml-auto text-xs",children:["Scroll to zoom · Drag to pan · Click nodes to expand · Right-click for notes",c&&" · Esc to exit"]})]}),O=t.jsx("div",{ref:a,className:"border-skin-line bg-skin-fill relative overflow-hidden rounded-lg border",style:{height:c?"calc(100vh - 120px)":"600px",touchAction:"none"},onPointerDown:T,onPointerMove:X,onPointerUp:_,children:t.jsx("svg",{className:"mindmap-canvas",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",display:"block"},children:t.jsxs("g",{transform:`translate(${l.x}, ${l.y}) scale(${b})`,children:[t.jsx("defs",{children:t.jsx("marker",{id:"ref-arrow",markerWidth:"8",markerHeight:"8",refX:"7",refY:"4",orient:"auto",children:t.jsx("path",{d:"M 0 0 L 8 4 L 0 8 Z",fill:"#888",opacity:"0.5"})})}),u.filter(e=>!e.isRef).map(e=>{const n=w.get(e.from),o=w.get(e.to);if(!n||!o)return null;const d=h===e.from||h===e.to;return t.jsx("path",{d:U(n.x,n.y,o.x,o.y),fill:"none",stroke:o.color,strokeWidth:d?2.5:1.5,opacity:h?d?.9:.15:.5,style:{transition:"opacity 0.2s, stroke-width 0.2s"}},`${e.from}-${e.to}`)}),u.filter(e=>e.isRef).map(e=>{const n=w.get(e.from),o=w.get(e.to);if(!n||!o)return null;const d=h===e.from||h===e.to;return t.jsxs("g",{children:[t.jsx("path",{d:J(n.x,n.y,o.x,o.y),fill:"none",stroke:"#F59E0B",strokeWidth:d?2:1.2,strokeDasharray:"6 4",opacity:h?d?.9:.12:.4,markerEnd:"url(#ref-arrow)",style:{transition:"opacity 0.2s"}}),e.label&&t.jsx("text",{x:(n.x+o.x)/2,y:(n.y+o.y)/2-8,textAnchor:"middle",fontSize:"9",fill:"#F59E0B",opacity:h?d?.9:.1:.55,style:{pointerEvents:"none"},children:e.label})]},`ref-${e.from}-${e.to}`)}),j.map(e=>{const n=e.depth===0,o=K(e.label,e.depth),d=n?te:ee,k=(B.get(e.id)??0)>0,C=m.has(e.id),M=h===e.id,N=i?.id===e.id,V=!!e.node.notes,G=!!e.node.annotation,Q=B.get(e.id)??0,z=k&&!C?Q:0;return t.jsxs("g",{transform:`translate(${e.x}, ${e.y})`,onMouseEnter:()=>g(e.id),onMouseLeave:()=>g(null),onClick:S=>{S.stopPropagation(),k&&W(e.id)},onContextMenu:S=>{S.preventDefault(),S.stopPropagation(),V&&x(i?.id===e.id?null:e.node)},style:{cursor:k?"pointer":"default"},children:[t.jsx("rect",{x:-o/2,y:-d/2,width:o,height:d,rx:n?12:8,fill:n?e.color:N?e.color+"30":M?e.color+"20":e.color+"12",stroke:e.color,strokeWidth:n?2.5:N?2:M?1.5:1,opacity:h&&!M&&h!==e.parentId?(()=>{const S=w.get(h);return S&&(e.parentId===h||S.parentId===e.id)?.9:.4})():1,style:{transition:"opacity 0.2s, fill 0.15s, stroke-width 0.15s"}}),t.jsx("text",{textAnchor:"middle",dominantBaseline:"central",fontSize:n?15:e.depth===1?12:10.5,fontWeight:n||e.depth===1?"bold":"500",fill:n?"#ffffff":e.color,style:{pointerEvents:"none",userSelect:"none"},children:e.label}),G&&t.jsxs("g",{transform:`translate(${o/2-4}, ${-d/2-6})`,children:[t.jsx("rect",{x:-2,y:-7,width:(e.node.annotation?.length??0)*5.5+10,height:14,rx:4,fill:e.color,opacity:.85}),t.jsx("text",{x:3,fontSize:"8",fontWeight:"600",fill:"white",style:{pointerEvents:"none",userSelect:"none"},children:e.node.annotation})]}),z>0&&t.jsxs("g",{transform:`translate(${o/2+4}, 0)`,children:[t.jsx("circle",{r:9,fill:e.color,opacity:.7}),t.jsxs("text",{textAnchor:"middle",dominantBaseline:"central",fontSize:"8",fontWeight:"bold",fill:"white",style:{pointerEvents:"none",userSelect:"none"},children:["+",z]})]}),V&&t.jsx("circle",{cx:o/2+(z>0?20:4),cy:-d/2+4,r:3.5,fill:N?e.color:"#F59E0B",opacity:M||N?1:.5,style:{transition:"opacity 0.15s"}})]},e.id)})]})})});return c?t.jsxs("div",{style:{position:"fixed",inset:0,zIndex:9999,display:"flex",flexDirection:"column",gap:"0.5rem",padding:"0.75rem",backgroundColor:"rgb(var(--color-fill))",overflow:"hidden"},children:[t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("h2",{className:"text-skin-base text-base leading-tight font-bold",children:s.title}),t.jsx("button",{onClick:P,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2 py-1 text-xs transition-colors",title:"Exit (Esc)",children:"✕ Exit"})]}),D,O,i&&i.notes&&t.jsx("div",{style:{flexShrink:0,maxHeight:"30vh",overflowY:"auto"},children:t.jsx(Y,{node:i,onClose:()=>x(null)})})]}):t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-skin-base text-xl font-bold",children:s.title}),t.jsx("p",{className:"text-skin-base/70 mt-1 text-sm",children:s.description})]}),D,O,i&&i.notes&&t.jsx(Y,{node:i,onClose:()=>x(null)})]})}export{oe as MindMapViewer};
