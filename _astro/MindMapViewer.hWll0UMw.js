import{j as t}from"./jsx-runtime.D_zvdyIk.js";import{r as i}from"./index.DiEladB3.js";function V({node:n,onClose:c}){return t.jsxs("div",{className:"border-skin-accent/30 bg-skin-card rounded-lg border p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("h3",{className:"text-skin-base font-semibold",style:n.color?{color:n.color}:void 0,children:n.label}),n.annotation&&t.jsx("span",{className:"rounded px-1.5 py-0.5 text-xs font-medium text-white",style:{backgroundColor:n.color||"#888"},children:n.annotation})]}),t.jsx("button",{onClick:c,className:"text-skin-base/60 hover:bg-skin-card-muted hover:text-skin-accent flex h-6 w-6 flex-shrink-0 items-center justify-center rounded transition-colors","aria-label":"Close notes",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),t.jsx("p",{className:"text-skin-base/80 mt-2 text-sm leading-relaxed",children:n.notes}),n.refs&&n.refs.length>0&&t.jsxs("div",{className:"border-skin-line/30 mt-3 border-t pt-2",children:[t.jsx("p",{className:"text-skin-base/50 text-xs font-medium tracking-wide uppercase",children:"Related"}),t.jsx("div",{className:"mt-1 flex flex-wrap gap-1.5",children:n.refs.map(r=>t.jsxs("span",{className:"inline-flex items-center gap-1 rounded bg-yellow-500/10 px-2 py-0.5 text-xs text-yellow-600 dark:text-yellow-400",children:[r.label&&t.jsx("span",{className:"opacity-70",children:r.label}),t.jsx("span",{className:"font-medium",children:r.targetId})]},r.targetId))})]})]})}const F=["#326CE5","#0F1689","#7B42BC","#E00","#0EA5E9","#F59E0B","#10B981","#EC4899"];function X(n){const c=[],r=[],h=new Map;function a(l){if(!l.children||l.children.length===0)return h.set(l.id,1),1;let u=0;for(const p of l.children)u+=a(p);return h.set(l.id,u),u}a(n);const b=[0,220,400,560,700,830],m=l=>l<b.length?b[l]:b[b.length-1]+(l-b.length+1)*140;c.push({id:n.id,label:n.label,x:0,y:0,color:"#888",node:n,depth:0,parentId:null});function x(l,u,p,j,M,A){if(!l.children||l.children.length===0)return;const $=h.get(l.id)||1,S=m(p);let v=j;l.children.forEach((g,L)=>{const W=h.get(g.id)||1,R=(M-j)*W/$,I=v+R/2,B=g.color||(p===1?F[L%F.length]:A),H=Math.cos(I)*S,z=Math.sin(I)*S;if(c.push({id:g.id,label:g.label,x:H,y:z,color:B,node:g,depth:p,parentId:u}),r.push({from:u,to:g.id,isRef:!1}),g.refs)for(const P of g.refs)r.push({from:g.id,to:P.targetId,isRef:!0,label:P.label});x(g,g.id,p+1,v,v+R,B),v+=R})}const f=-Math.PI,y=Math.PI;return x(n,n.id,1,f,y,"#888"),{nodes:c,edges:r}}function _(n,c,r,h){const a=(n+r)/2,b=(c+h)/2,m=r-n,x=h-c,f=Math.sqrt(m*m+x*x)||1,y=f*.15,l=-x/f,u=m/f,p=a+l*y,j=b+u*y;return`M ${n} ${c} Q ${p} ${j} ${r} ${h}`}function q(n,c,r,h){const a=(n+r)/2,b=(c+h)/2,m=r-n,x=h-c,f=Math.sqrt(m*m+x*x)||1,y=-x/f,l=m/f,u=f*.25,p=a+y*u,j=b+l*u;return`M ${n} ${c} Q ${p} ${j} ${r} ${h}`}function G(n,c){const h=(c===0?16:c===1?13:11)*.62;return Math.max(60,n.length*h+28)}const Q=32,Z=40;function K({mindmap:n}){const c=i.useRef(null),[r,h]=i.useState(null),[a,b]=i.useState(null),[m,x]=i.useState(()=>{const e=new Set;return e.add(n.root.id),n.root.children?.forEach(o=>{e.add(o.id),o.children?.forEach(s=>e.add(s.id))}),e}),[f,y]=i.useState({x:0,y:0}),[l,u]=i.useState(.65),p=i.useRef(!1),j=i.useRef({x:0,y:0}),M=i.useRef({x:0,y:0}),A=i.useMemo(()=>{function e(o){return!m.has(o.id)||!o.children?{...o,children:void 0}:{...o,children:o.children.map(e)}}return e(n.root)},[n.root,m]),{nodes:$,edges:S}=i.useMemo(()=>X(A),[A]),v=i.useMemo(()=>{const e=new Map;for(const o of $)e.set(o.id,o);return e},[$]),g=i.useCallback(e=>{function o(d){if(d.id===e)return d;if(d.children)for(const k of d.children){const w=o(k);if(w)return w}return null}const s=o(n.root);!s||!s.children||s.children.length===0||x(d=>{const k=new Set(d);if(k.has(e)){let w=function(C){if(C.children)for(const N of C.children)k.delete(N.id),w(N)};k.delete(e),w(s)}else k.add(e);return k})},[n.root]),L=i.useCallback(()=>{const e=new Set;function o(s){e.add(s.id),s.children?.forEach(o)}o(n.root),x(e)},[n]),W=i.useCallback(()=>{x(new Set([n.root.id]))},[n]),R=i.useCallback(()=>{y({x:0,y:0}),u(.65)},[]),I=i.useMemo(()=>{const e=new Map;function o(s){e.set(s.id,s.children?.length??0),s.children?.forEach(o)}return o(n.root),e},[n.root]),B=i.useCallback(e=>{e.button===0&&(p.current=!0,j.current={x:e.clientX,y:e.clientY},M.current={...f},e.target.setPointerCapture?.(e.pointerId))},[f]),H=i.useCallback(e=>{if(!p.current)return;const o=e.clientX-j.current.x,s=e.clientY-j.current.y;y({x:M.current.x+o,y:M.current.y+s})},[]),z=i.useCallback(()=>{p.current=!1},[]),P=i.useCallback(e=>{e.preventDefault();const o=e.deltaY>0?.92:1.08;u(s=>Math.max(.15,Math.min(3,s*o)))},[]);return i.useEffect(()=>{if(c.current){const e=c.current.getBoundingClientRect();y({x:e.width/2,y:e.height/2})}},[]),t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-skin-base text-xl font-bold",children:n.title}),t.jsx("p",{className:"text-skin-base/70 mt-1 text-sm",children:n.description})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx("button",{onClick:L,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",children:"Expand All"}),t.jsx("button",{onClick:W,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",children:"Collapse All"}),t.jsx("button",{onClick:R,className:"border-skin-line text-skin-base hover:border-skin-accent hover:text-skin-accent rounded border px-2.5 py-1 text-xs transition-colors",children:"Reset View"}),t.jsx("span",{className:"text-skin-base/50 ml-auto text-xs",children:"Scroll to zoom · Drag to pan · Click nodes to expand · Right-click for notes"})]}),t.jsx("div",{ref:c,className:"border-skin-line bg-skin-fill relative overflow-hidden rounded-lg border",style:{height:"600px",touchAction:"none"},onPointerDown:B,onPointerMove:H,onPointerUp:z,onWheel:P,children:t.jsx("svg",{width:"100%",height:"100%",style:{position:"absolute",top:0,left:0},children:t.jsxs("g",{transform:`translate(${f.x}, ${f.y}) scale(${l})`,children:[t.jsx("defs",{children:t.jsx("marker",{id:"ref-arrow",markerWidth:"8",markerHeight:"8",refX:"7",refY:"4",orient:"auto",children:t.jsx("path",{d:"M 0 0 L 8 4 L 0 8 Z",fill:"#888",opacity:"0.5"})})}),S.filter(e=>!e.isRef).map(e=>{const o=v.get(e.from),s=v.get(e.to);if(!o||!s)return null;const d=a===e.from||a===e.to;return t.jsx("path",{d:_(o.x,o.y,s.x,s.y),fill:"none",stroke:s.color,strokeWidth:d?2.5:1.5,opacity:a?d?.9:.15:.5,style:{transition:"opacity 0.2s, stroke-width 0.2s"}},`${e.from}-${e.to}`)}),S.filter(e=>e.isRef).map(e=>{const o=v.get(e.from),s=v.get(e.to);if(!o||!s)return null;const d=a===e.from||a===e.to;return t.jsxs("g",{children:[t.jsx("path",{d:q(o.x,o.y,s.x,s.y),fill:"none",stroke:"#F59E0B",strokeWidth:d?2:1.2,strokeDasharray:"6 4",opacity:a?d?.9:.12:.4,markerEnd:"url(#ref-arrow)",style:{transition:"opacity 0.2s"}}),e.label&&t.jsx("text",{x:(o.x+s.x)/2,y:(o.y+s.y)/2-8,textAnchor:"middle",fontSize:"9",fill:"#F59E0B",opacity:a?d?.9:.1:.55,style:{pointerEvents:"none"},children:e.label})]},`ref-${e.from}-${e.to}`)}),$.map(e=>{const o=e.depth===0,s=G(e.label,e.depth),d=o?Z:Q,k=(I.get(e.id)??0)>0,w=m.has(e.id),C=a===e.id,N=r?.id===e.id,O=!!e.node.notes,Y=!!e.node.annotation,T=I.get(e.id)??0,D=k&&!w?T:0;return t.jsxs("g",{transform:`translate(${e.x}, ${e.y})`,onMouseEnter:()=>b(e.id),onMouseLeave:()=>b(null),onClick:E=>{E.stopPropagation(),k&&g(e.id)},onContextMenu:E=>{E.preventDefault(),E.stopPropagation(),O&&h(r?.id===e.id?null:e.node)},style:{cursor:k?"pointer":"default"},children:[t.jsx("rect",{x:-s/2,y:-d/2,width:s,height:d,rx:o?12:8,fill:o?"var(--color-card)":N?e.color+"30":C?e.color+"20":e.color+"12",stroke:e.color,strokeWidth:o?2.5:N?2:C?1.5:1,opacity:a&&!C&&a!==e.parentId?(()=>{const E=v.get(a);return E&&(e.parentId===a||E.parentId===e.id)?.9:.4})():1,style:{transition:"opacity 0.2s, fill 0.15s, stroke-width 0.15s"}}),t.jsx("text",{textAnchor:"middle",dominantBaseline:"central",fontSize:o?15:e.depth===1?12:10.5,fontWeight:o||e.depth===1?"bold":"500",fill:o?"var(--color-text-base)":e.color,style:{pointerEvents:"none",userSelect:"none"},children:e.label}),Y&&t.jsxs("g",{transform:`translate(${s/2-4}, ${-d/2-6})`,children:[t.jsx("rect",{x:-2,y:-7,width:(e.node.annotation?.length??0)*5.5+10,height:14,rx:4,fill:e.color,opacity:.85}),t.jsx("text",{x:3,fontSize:"8",fontWeight:"600",fill:"white",style:{pointerEvents:"none",userSelect:"none"},children:e.node.annotation})]}),D>0&&t.jsxs("g",{transform:`translate(${s/2+4}, 0)`,children:[t.jsx("circle",{r:9,fill:e.color,opacity:.7}),t.jsxs("text",{textAnchor:"middle",dominantBaseline:"central",fontSize:"8",fontWeight:"bold",fill:"white",style:{pointerEvents:"none",userSelect:"none"},children:["+",D]})]}),O&&t.jsx("circle",{cx:s/2+(D>0?20:4),cy:-d/2+4,r:3.5,fill:N?e.color:"#F59E0B",opacity:C||N?1:.5,style:{transition:"opacity 0.15s"}})]},e.id)})]})})}),r&&r.notes&&t.jsx(V,{node:r,onClose:()=>h(null)})]})}export{K as MindMapViewer};
